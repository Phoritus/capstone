name: Build and Push Container Images

on:
  workflow_dispatch:
  
jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: filter
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          filters: .github/utils/file-filter.yaml

  build-push-container-images:
    runs-on: ubuntu-latest
    needs: filter
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.filter.outputs.services) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Dependencies
        uses: ./.github/actions/setup-dependencies
        with:
          task_version: v3.45.5

      # - name: Auth to Docker Hub
      #   if: ${{ !env.ACT }}
      #   uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      #   with:
      #     username: ${{ vars.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      # - name: Set up QEMU
      #   uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 #v3.7.0
      # - name: Set up Buildx
      #   uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 #v3.11.1
      # - name: Compute image tags
      #   id: image_tags
      #   run: |
      #     version=foo
      #     image_tag=foo_bar
      #     echo "version=${version}" >> $GITHUB_OUTPUT
      #     echo "image_tag=${image_tag}" >> $GITHUB_OUTPUT
        

      #     # TODO: Generate the actual version/tag
      # - name: Print context
      #   run: |
      #     echo "Services: ${{ matrix.service }}"
      #     ls -R ${{ matrix.service }}
      #     pwd 
      # - name: Build and push images
      #   uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0    
      #   with:
      #     context: ${{ matrix.service }}
      #     push: ${{ !env.ACT }}
      #     tags: ${{ steps.image_tags.outputs.image_tag }}
      #     platforms: linux/amd64
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max